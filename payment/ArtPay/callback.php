<?php/** * Turbo CMS * * К этому скрипту обращается ArtPay в процессе оплаты * */
// Работаем в корневой директорииchdir ('../../');require_once('api/Turbo.php');$turbo = new Turbo();$payaction = $_GET['payaction'];if($payaction == "notify"){	if (		!$request = file_get_contents("php://input")	) {		header("HTTP/1.1 400 Bad Request");		echo 'ERROR: Нет данных!';		return 0;	}		$data = json_decode($request, true);		$ap_order_num = $data['ap_order_num'];	$order = $turbo->orders->get_order($ap_order_num);	$payment_method = $turbo->payment->get_payment_method($order->payment_method_id);	$payment_settings = $turbo->payment->get_payment_settings($payment_method->id);	if (		!checkSignature($data, $payment_settings['artpay_secret2'])	) {		header("HTTP/1.1 400 Bad Request");		echo 'ERROR: Ошибка проверки подписи!';		return 0;	}		// Установим статус оплачен	$turbo->orders->update_order(intval($order->id), array('paid'=>1));	$turbo->orders->close(intval($order->id));	//$turbo->notify->email_order_user(intval($order->id));	//$turbo->notify->email_order_admin(intval($order->id));		exit;}if($payaction == "success"){	$ap_order_num = $_POST['ap_order_num'];	$order = $turbo->orders->get_order((int)$ap_order_num);	$payment_method = $turbo->payment->get_payment_method($order->payment_method_id);	$payment_settings = $turbo->payment->get_payment_settings($payment_method->id);		if (			checkSignature($_POST, $payment_settings['artpay_secret2'])		) {			header('Location:'.$this->config->root_url.'/order/'.$order->url);						return TRUE;				} else {			header("HTTP/1.1 400 Bad Request");			echo 'WRONG  SIGNATURE';						exit;		}		return FALSE;}if($payaction == "fail"){	$ap_order_num = $_POST['ap_order_num'];	$order = $turbo->orders->get_order((int)$ap_order_num);	$payment_method = $turbo->payment->get_payment_method($order->payment_method_id);	$payment_settings = $turbo->payment->get_payment_settings($payment_method->id);		if (		!checkSignature($_POST, $payment_settings['artpay_secret2'])	) {		header("HTTP/1.1 400 Bad Request");		echo 'ERROR: Ошибка проверки подписи!';		return 0;	}	header('Location:'.$turbo->config->root_url);				return FALSE;}
function checkSignature($data, $secret, $algo = 'sha512'){	if (!isset($data['ap_signature']))		return false;	$addSignature = $data['ap_signature'];	unset($data['ap_signature']);			uksort($data, 'strnatcmp');	$string =  implode(';', $data) . ';' . $secret;			return hash($algo, $string) == $addSignature;}
